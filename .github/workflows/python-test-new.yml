name: Python Test Workflow

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    
    # Job seviyesinde sonuÃ§larÄ± saklamak iÃ§in outputs
    outputs:
      lint_status: ${{ steps.lint_check.outputs.status }}
      lint_errors: ${{ steps.lint_check.outputs.errors }}
      test_status: ${{ steps.run_tests.outputs.status }}
      test_coverage: ${{ steps.run_tests.outputs.coverage }}
      docker_status: ${{ steps.docker_test.outputs.status }}
      overall_status: ${{ steps.set_status.outputs.status }}
      status_emoji: ${{ steps.set_status.outputs.emoji }}
      status_message: ${{ steps.set_status.outputs.message }}

    steps:
      - name: Kodu al
        uses: actions/checkout@v3

      - name: Python ortamÄ±nÄ± kur
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov flake8

      - name: Lint kontrolÃ¼ (flake8)
        id: lint_check
        continue-on-error: true
        run: |
          echo "ðŸ§¹ Kod kalitesi kontrolÃ¼ baÅŸlatÄ±lÄ±yor..."
          
          # Kritik hatalarÄ± kontrol et (syntax errors)
          CRITICAL_ERRORS=$(flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics 2>&1 || true)
          
          # Genel lint kontrolÃ¼
          LINT_OUTPUT=$(flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics 2>&1 || true)
          
          # Hata sayÄ±sÄ±nÄ± bul
          ERROR_COUNT=$(echo "$LINT_OUTPUT" | grep -oP '\d+(?= error)' | head -1 || echo "0")
          if [ -z "$ERROR_COUNT" ]; then
            ERROR_COUNT=0
          fi
          
          # Kritik hata var mÄ± kontrol et
          if echo "$CRITICAL_ERRORS" | grep -q "SyntaxError\|IndentationError"; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "errors=$CRITICAL_ERRORS" >> $GITHUB_OUTPUT
            echo "âŒ Lint kontrolÃ¼ BAÅžARISIZ: Syntax hatasÄ± bulundu!"
            exit 1
          elif [ "$ERROR_COUNT" -gt 0 ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "errors=$LINT_OUTPUT" >> $GITHUB_OUTPUT
            echo "âš ï¸ Lint kontrolÃ¼: $ERROR_COUNT hata bulundu (kritik deÄŸil)"
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "errors=" >> $GITHUB_OUTPUT
            echo "âœ… Lint kontrolÃ¼ baÅŸarÄ±lÄ±!"
          fi

      - name: Testleri Ã§alÄ±ÅŸtÄ±r ve coverage raporu oluÅŸtur
        id: run_tests
        continue-on-error: true
        run: |
          echo "ðŸš€ Testler baÅŸlatÄ±lÄ±yor..."
          
          # Testleri Ã§alÄ±ÅŸtÄ±r ve sonucu yakala
          if pytest --cov=. --cov-report=term-missing --cov-report=xml --cov-report=json -v 2>&1 | tee test_output.txt; then
            echo "status=success" >> $GITHUB_OUTPUT
            
            # Coverage yÃ¼zdesini bul
            COVERAGE=$(python -c "import json; data=json.load(open('.coverage.json')); print(f\"{data['totals']['percent_covered']:.1f}%\")" 2>/dev/null || echo "N/A")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "âœ… Testler baÅŸarÄ±lÄ±! Coverage: $COVERAGE"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "coverage=N/A" >> $GITHUB_OUTPUT
            echo "âŒ Testler baÅŸarÄ±sÄ±z!"
            
            # Test hatalarÄ±nÄ± gÃ¶ster
            if [ -f test_output.txt ]; then
              echo "Test hatalarÄ±:"
              cat test_output.txt | grep -A 5 "FAILED\|ERROR" || true
            fi
            exit 1
          fi

      - name: Coverage raporunu yÃ¼kle (Artifact)
        if: steps.run_tests.outputs.status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

      - name: Docker kurulumu
        if: steps.run_tests.outputs.status == 'success'
        uses: docker/setup-buildx-action@v3

      - name: Docker image oluÅŸtur
        id: docker_build
        if: steps.run_tests.outputs.status == 'success'
        continue-on-error: true
        run: |
          if docker build -t actions-deneme . 2>&1 | tee docker_build.txt; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Docker image baÅŸarÄ±yla oluÅŸturuldu!"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Docker build baÅŸarÄ±sÄ±z!"
            exit 1
          fi

      - name: Docker image'larÄ± listele ve gÃ¶rÃ¼ntÃ¼le
        if: steps.docker_build.outputs.status == 'success' || steps.docker_build.outcome == 'success'
        run: |
          echo "ðŸ“¦ OluÅŸturulan Docker image'larÄ±:"
          docker images
          echo ""
          echo "ðŸ“Š actions-deneme image detaylarÄ±:"
          docker images actions-deneme

      - name: Docker container'Ä± test et
        id: docker_test
        if: steps.docker_build.outputs.status == 'success' || steps.docker_build.outcome == 'success'
        continue-on-error: true
        run: |
          if docker run --rm actions-deneme 2>&1 | tee docker_run.txt; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Docker container testi baÅŸarÄ±lÄ±!"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ Docker container testi baÅŸarÄ±sÄ±z!"
            if [ -f docker_run.txt ]; then
              echo "Container Ã§Ä±ktÄ±sÄ±:"
              cat docker_run.txt
            fi
            exit 1
          fi

      - name: Container iÃ§indeki dosyalarÄ± listele
        if: (steps.docker_test.outputs.status == 'success' || steps.docker_test.outcome == 'success')
        run: docker run --rm actions-deneme ls -la /app

      - name: Genel durum belirleme
        id: set_status
        run: |
          LINT_STATUS="${{ steps.lint_check.outputs.status }}"
          TEST_STATUS="${{ steps.run_tests.outputs.status }}"
          DOCKER_STATUS="${{ steps.docker_test.outputs.status }}"
          
          # Genel durumu belirle
          if [ "$TEST_STATUS" = "failed" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Testler baÅŸarÄ±sÄ±z oldu" >> $GITHUB_OUTPUT
          elif [ "$DOCKER_STATUS" = "failed" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Docker testi baÅŸarÄ±sÄ±z oldu" >> $GITHUB_OUTPUT
          elif [ "$LINT_STATUS" = "failed" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Lint kontrolÃ¼ baÅŸarÄ±sÄ±z (syntax hatasÄ±)" >> $GITHUB_OUTPUT
          elif [ "$LINT_STATUS" = "warning" ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
            echo "message=Testler geÃ§ti ama lint uyarÄ±larÄ± var" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=TÃ¼m testler baÅŸarÄ±yla tamamlandÄ±" >> $GITHUB_OUTPUT
          fi

      - name: DetaylÄ± bildirim gÃ¶nder (E-posta ve Slack)
        if: always()
        run: |
          echo "ðŸ“¬ Test sonuÃ§larÄ± hazÄ±rlanÄ±yor..."
          
          # Durum bilgilerini al
          LINT_STATUS="${{ steps.lint_check.outputs.status }}"
          TEST_STATUS="${{ steps.run_tests.outputs.status }}"
          DOCKER_STATUS="${{ steps.docker_test.outputs.status }}"
          OVERALL_STATUS="${{ steps.set_status.outputs.status }}"
          STATUS_EMOJI="${{ steps.set_status.outputs.emoji }}"
          STATUS_MESSAGE="${{ steps.set_status.outputs.message }}"
          COVERAGE="${{ steps.run_tests.outputs.coverage }}"
          
          # Workflow bilgileri
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          BRANCH="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"
          
          # Email iÃ§eriÄŸi oluÅŸtur
          EMAIL_BODY=$(cat <<EOF
          $STATUS_EMOJI Test SonuÃ§larÄ± - $STATUS_MESSAGE
          
          ðŸ“Š DetaylÄ± Rapor:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          ðŸ” Lint KontrolÃ¼: $LINT_STATUS
          ðŸ§ª Test Durumu: $TEST_STATUS
          ðŸ³ Docker Testi: $DOCKER_STATUS
          ðŸ“ˆ Coverage: $COVERAGE
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          ðŸ“ Commit Bilgileri:
          â€¢ Branch: $BRANCH
          â€¢ Commit: ${COMMIT_SHA:0:7}
          â€¢ Mesaj: $COMMIT_MSG
          â€¢ KullanÄ±cÄ±: $ACTOR
          
          ðŸ”— Workflow DetaylarÄ±:
          $WORKFLOW_URL
          
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          EOF
          )
          
          # Hata detaylarÄ± varsa ekle
          if [ "$LINT_STATUS" = "failed" ] || [ "$LINT_STATUS" = "warning" ]; then
            LINT_ERRORS="${{ steps.lint_check.outputs.errors }}"
            if [ -n "$LINT_ERRORS" ]; then
              EMAIL_BODY="${EMAIL_BODY}
          âš ï¸ Lint HatalarÄ±:
          $LINT_ERRORS
          
          "
            fi
          fi
          
          # Test hatalarÄ± varsa ekle
          if [ "$TEST_STATUS" = "failed" ]; then
            if [ -f test_output.txt ]; then
              TEST_ERRORS=$(tail -50 test_output.txt)
              EMAIL_BODY="${EMAIL_BODY}
          âŒ Test HatalarÄ±:
          $TEST_ERRORS
          
          "
            fi
          fi
          
          # Docker hatalarÄ± varsa ekle
          if [ "$DOCKER_STATUS" = "failed" ]; then
            if [ -f docker_run.txt ]; then
              DOCKER_ERRORS=$(cat docker_run.txt)
              EMAIL_BODY="${EMAIL_BODY}
          âŒ Docker HatalarÄ±:
          $DOCKER_ERRORS
          
          "
            fi
          fi
          
          # Email subject
          if [ "$OVERALL_STATUS" = "success" ]; then
            EMAIL_SUBJECT="âœ… Test SonuÃ§larÄ± - BaÅŸarÄ±lÄ±"
          elif [ "$OVERALL_STATUS" = "warning" ]; then
            EMAIL_SUBJECT="âš ï¸ Test SonuÃ§larÄ± - UyarÄ±lar Var"
          else
            EMAIL_SUBJECT="âŒ Test SonuÃ§larÄ± - BaÅŸarÄ±sÄ±z"
          fi
          
          # ---- SLACK ----
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            SLACK_MESSAGE=$(cat <<EOF
          {
            "text": "$STATUS_EMOJI *$STATUS_MESSAGE*",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "$STATUS_EMOJI Test SonuÃ§larÄ±"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Lint:*\n$LINT_STATUS"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Test:*\n$TEST_STATUS"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Docker:*\n$DOCKER_STATUS"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Coverage:*\n$COVERAGE"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "<$WORKFLOW_URL|Workflow DetaylarÄ±>"
                }
              }
            ]
          }
          EOF
          )
            
            curl -X POST -H 'Content-type: application/json' \
              --data "$SLACK_MESSAGE" \
              ${{ secrets.SLACK_WEBHOOK_URL }} || echo "Slack bildirimi gÃ¶nderilemedi"
          fi
          
          # ---- E-POSTA ----
          python - <<EOF
          import smtplib
          from email.mime.text import MIMEText
          import os
          
          email_body = """$EMAIL_BODY"""
          email_subject = """$EMAIL_SUBJECT"""
          
          msg = MIMEText(email_body, 'plain', 'utf-8')
          msg["Subject"] = email_subject
          msg["From"] = "${{ secrets.EMAIL_USER }}"
          msg["To"] = "${{ secrets.EMAIL_USER }}"
          
          try:
              with smtplib.SMTP("${{ secrets.EMAIL_HOST }}", int("${{ secrets.EMAIL_PORT }}")) as server:
                  server.starttls()
                  server.login("${{ secrets.EMAIL_USER }}", "${{ secrets.EMAIL_PASS }}")
                  server.send_message(msg)
              print("âœ… Email baÅŸarÄ±yla gÃ¶nderildi")
          except Exception as e:
              print(f"âŒ Email gÃ¶nderilemedi: {e}")
          EOF
