name: Python Test Workflow (Genişletilmiş)

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]

    steps:
      - name: Kodu al
        uses: actions/checkout@v3

      - name: Python ortamını kur
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}

      - name: Gerekli bağımlılıkları yükle
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov flake8

      - name: Lint kontrolü (flake8)
        run: |
          echo "🧹 Kod kalitesi kontrol ediliyor..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Test dosyalarını çalıştır (pytest + coverage)
        run: |
          echo "🚀 Testler başlatılıyor..."
          pytest --cov=. --cov-report=term-missing || echo "❌ Bazı testler hatalı olabilir"

      - name: Bildirim gönder (E-posta ve Slack)
        if: always()
        run: |
          echo "📬 Testler bitti, bildirimler gönderiliyor..."

          # ---- SLACK BİLDİRİMİ ----
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"✅ *Tüm testler tamamlandı!* 🚀 Deploy işlemi başlatılıyor..."}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

          # ---- E-POSTA BİLDİRİMİ ----
          python - <<EOF
          import smtplib
          from email.mime.text import MIMEText

          msg = MIMEText("✅ Testler tamamlandı!\nSonuç: Başarılı 🎉")
          msg["Subject"] = "✅ Test Sonuçları - Başarılı"
          msg["From"] = "${{ secrets.EMAIL_USER }}"
          msg["To"] = "${{ secrets.EMAIL_USER }}"

          with smtplib.SMTP("${{ secrets.EMAIL_HOST }}", int("${{ secrets.EMAIL_PORT }}")) as server:
              server.starttls()
              server.login("${{ secrets.EMAIL_USER }}", "${{ secrets.EMAIL_PASS }}")
              server.send_message(msg)
          EOF
