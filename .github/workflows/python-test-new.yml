name: Python Test Workflow (GeniÅŸletilmiÅŸ)

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11,3.12]

    steps:
      - name: Kodu al
        uses: actions/checkout@v3

      - name: Python ortamÄ±nÄ± kur
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}

      - name: Gerekli baÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov flake8

      - name: Lint kontrolÃ¼ (flake8)
        run: |
          echo "ğŸ§¹ Kod kalitesi kontrol ediliyor..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Test dosyalarÄ±nÄ± Ã§alÄ±ÅŸtÄ±r (pytest + coverage)
        run: |
          echo "ğŸš€ Testler baÅŸlatÄ±lÄ±yor..."
          pytest --cov=. --cov-report=term-missing || echo "âŒ BazÄ± testler hatalÄ± olabilir"

      - name: Bildirim gÃ¶nder (E-posta ve Slack)
        if: always()
        run: |
          echo "ğŸ“¬ Testler bitti, bildirimler gÃ¶nderiliyor..."

          # ---- SLACK BÄ°LDÄ°RÄ°MÄ° ----
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"âœ… *TÃ¼m testler tamamlandÄ±!* ğŸš€ Deploy iÅŸlemi baÅŸlatÄ±lÄ±yor..."}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

          # ---- E-POSTA BÄ°LDÄ°RÄ°MÄ° ----
          python - <<EOF
          import smtplib
          from email.mime.text import MIMEText

          msg = MIMEText("âœ… Testler tamamlandÄ±!\nSonuÃ§: BaÅŸarÄ±lÄ± ğŸ‰")
          msg["Subject"] = "âœ… Test SonuÃ§larÄ± - BaÅŸarÄ±lÄ±"
          msg["From"] = "${{ secrets.EMAIL_USER }}"
          msg["To"] = "${{ secrets.EMAIL_USER }}"

          with smtplib.SMTP("${{ secrets.EMAIL_HOST }}", int("${{ secrets.EMAIL_PORT }}")) as server:
              server.starttls()
              server.login("${{ secrets.EMAIL_USER }}", "${{ secrets.EMAIL_PASS }}")
              server.send_message(msg)
          EOF
