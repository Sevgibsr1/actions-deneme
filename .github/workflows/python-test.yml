name: Python Test Workflow

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Kodu al
        uses: actions/checkout@v3

      - name: Python ortamÄ±nÄ± kur
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name: Test dosyalarÄ±nÄ± Ã§alÄ±ÅŸtÄ±r
        run: |
          echo "ğŸš€ TÃ¼m testler baÅŸlatÄ±lÄ±yor..."
          python test_script.py || echo "test_script.py hatalÄ± âŒ"
          python test_carp.py || echo "test_carp.py hatalÄ± âŒ"
          python test_bol.py || echo "test_bol.py hatalÄ± âŒ"

      - name: Bildirim gÃ¶nder (E-posta ve Slack)
        if: always()  # ÅŸu an test iÃ§in her durumda Ã§alÄ±ÅŸsÄ±n
        run: |
          echo "ğŸ“¬ Testler bitti, bildirimler gÃ¶nderiliyor..."

          # ---- SLACK BÄ°LDÄ°RÄ°MÄ° ----
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"âœ… *TÃ¼m testler tamamlandÄ±!* ğŸš€ Deploy iÅŸlemi baÅŸlatÄ±lÄ±yor..."}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

          # ---- E-POSTA BÄ°LDÄ°RÄ°MÄ° ----
          python - <<EOF
          import smtplib
          from email.mime.text import MIMEText

          msg = MIMEText("âœ… TÃ¼m testler tamamlandÄ±!\nğŸš€ Deploy iÅŸlemi baÅŸlatÄ±lÄ±yor...")
          msg["Subject"] = "âœ… Test SonuÃ§larÄ± - BaÅŸarÄ±lÄ±"
          msg["From"] = "${{ secrets.EMAIL_USER }}"
          msg["To"] = "${{ secrets.EMAIL_USER }}"

          with smtplib.SMTP("${{ secrets.EMAIL_HOST }}", int("${{ secrets.EMAIL_PORT }}")) as server:
              server.starttls()
              server.login("${{ secrets.EMAIL_USER }}", "${{ secrets.EMAIL_PASS }}")
              server.send_message(msg)
          EOF
