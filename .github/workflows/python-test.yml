name: Python Test Workflow

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Kodu al
        uses: actions/checkout@v3

      - name: Python ortamını kur
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name: Test dosyalarını çalıştır
        run: |
          echo "🚀 Tüm testler başlatılıyor..."
          python test_script.py || echo "test_script.py hatalı ❌"
          python test_carp.py || echo "test_carp.py hatalı ❌"
          python test_bol.py || echo "test_bol.py hatalı ❌"

      - name: Bildirim gönder (E-posta ve Slack)
        if: always()  # şu an test için her durumda çalışsın
        run: |
          echo "📬 Testler bitti, bildirimler gönderiliyor..."

          # ---- SLACK BİLDİRİMİ ----
          curl -X POST -H 'Content-type: application/json' \
          --data '{"text":"✅ *Tüm testler tamamlandı!* 🚀 Deploy işlemi başlatılıyor..."}' \
          ${{ secrets.SLACK_WEBHOOK_URL }}

          # ---- E-POSTA BİLDİRİMİ ----
          python - <<EOF
          import smtplib
          from email.mime.text import MIMEText

          msg = MIMEText("✅ Tüm testler tamamlandı!\n🚀 Deploy işlemi başlatılıyor...")
          msg["Subject"] = "✅ Test Sonuçları - Başarılı"
          msg["From"] = "${{ secrets.EMAIL_USER }}"
          msg["To"] = "${{ secrets.EMAIL_USER }}, mehdiozdemir10@gmail.com"

          with smtplib.SMTP("${{ secrets.EMAIL_HOST }}", int("${{ secrets.EMAIL_PORT }}")) as server:
              server.starttls()
              server.login("${{ secrets.EMAIL_USER }}", "${{ secrets.EMAIL_PASS }}")
              server.send_message(msg)
          EOF
